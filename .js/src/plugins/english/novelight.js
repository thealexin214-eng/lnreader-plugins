var e=this&&this.__awaiter||function(e,t,a,l){return new(a||(a=Promise))((function(n,r){function o(e){try{u(l.next(e))}catch(e){r(e)}}function i(e){try{u(l.throw(e))}catch(e){r(e)}}function u(e){var t;e.done?n(e.value):(t=e.value,t instanceof a?t:new a((function(e){e(t)}))).then(o,i)}u((l=l.apply(e,t||[])).next())}))},t=this&&this.__generator||function(e,t){var a,l,n,r={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]},o=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return o.next=i(0),o.throw=i(1),o.return=i(2),"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function i(i){return function(u){return function(i){if(a)throw new TypeError("Generator is already executing.");for(;o&&(o=0,i[0]&&(r=0)),r;)try{if(a=1,l&&(n=2&i[0]?l.return:i[0]?l.throw||((n=l.return)&&n.call(l),0):l.next)&&!(n=n.call(l,i[1])).done)return n;switch(l=0,n&&(i=[2&i[0],n.value]),i[0]){case 0:case 1:n=i;break;case 4:return r.label++,{value:i[1],done:!1};case 5:r.label++,l=i[1],i=[0];continue;case 7:i=r.ops.pop(),r.trys.pop();continue;default:if(!(n=r.trys,(n=n.length>0&&n[n.length-1])||6!==i[0]&&2!==i[0])){r=0;continue}if(3===i[0]&&(!n||i[1]>n[0]&&i[1]<n[3])){r.label=i[1];break}if(6===i[0]&&r.label<n[1]){r.label=n[1],n=i;break}if(n&&r.label<n[2]){r.label=n[2],r.ops.push(i);break}n[2]&&r.ops.pop(),r.trys.pop();continue}i=t.call(e,r)}catch(e){i=[6,e],l=0}finally{a=n=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,u])}}},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});var l=require("cheerio"),n=require("@libs/fetch"),r=require("@libs/novelStatus"),o=require("@libs/filterInputs"),i=require("@libs/defaultCover"),u=a(require("dayjs")),s=require("@libs/storage"),c=function(){function a(){this.id="novelight",this.name="Novelight",this.version="1.1.4",this.icon="src/en/novelight/icon.png",this.site="https://novelight.net/",this.hideLocked=s.storage.get("hideLocked"),this.pluginSettings={hideLocked:{value:"",label:"Hide locked chapters",type:"Switch"}},this.filters={sort:{label:"Sort Results By",value:"popularity",options:[{label:"Title (A>Z)",value:"title"},{label:"Publication Date",value:"-time_created"},{label:"Update Date (Newest)",value:"-time_updated"},{label:"Year Release",value:"-year_of_release"},{label:"Popularity",value:"popularity"}],type:o.FilterTypes.Picker},translation:{label:"Translation Status",value:[],options:[{label:"Ongoing",value:"ongoing"},{label:"Completed",value:"completed"},{label:"Paused",value:"paused"},{label:"Dropped",value:"dropped"},{label:"None",value:"none"}],type:o.FilterTypes.CheckboxGroup},status:{label:"Status",value:[],options:[{label:"Releasing",value:"releasing"},{label:"Completed",value:"completed"},{label:"Cancelled",value:"cancelled"},{label:"Not yet released",value:"not+yet+released"}],type:o.FilterTypes.CheckboxGroup},novel_type:{label:"Type",value:[],options:[{label:"Fan Fiction",value:"4"},{label:"Light Novel",value:"1"},{label:"Published Novel",value:"2"},{label:"Web Novel",value:"3"}],type:o.FilterTypes.CheckboxGroup},genres:{label:"Genres",value:[],options:[{label:"Thriller",value:"1"},{label:"Supernatural",value:"2"},{label:"Sports",value:"3"},{label:"Slice of Life",value:"4"},{label:"Sci-Fi",value:"5"},{label:"Romance",value:"6"},{label:"Psychological",value:"7"},{label:"Mystery",value:"8"},{label:"Mecha",value:"9"},{label:"Horror",value:"10"},{label:"Fantasy",value:"11"},{label:"Ecchi",value:"12"},{label:"Drama",value:"13"},{label:"Comedy",value:"14"},{label:"Adventure",value:"15"},{label:"Action",value:"16"},{label:"Adult",value:"17"},{label:"Isekai",value:"18"},{label:"Wuxia",value:"19"},{label:"Shounen",value:"20"},{label:"Yuri",value:"21"},{label:"Shoujo",value:"22"},{label:"Shoujo Ai",value:"23"},{label:"Harem",value:"24"},{label:"Seinen",value:"25"},{label:"Tragedy",value:"26"},{label:"Mature",value:"27"},{label:"Martial Arts",value:"28"},{label:"Gender Bender",value:"29"},{label:"School Life",value:"30"},{label:"Xuanhuan",value:"31"},{label:"Yaoi",value:"32"},{label:"Historical",value:"33"}],type:o.FilterTypes.CheckboxGroup},country:{label:"Country",value:[],options:[{label:"China",value:"1"},{label:"Japan",value:"2"},{label:"Korea",value:"3"},{label:"Other",value:"6"}],type:o.FilterTypes.CheckboxGroup}}}return a.prototype.popularNovels=function(a,r){return e(this,arguments,void 0,(function(e,a){var r,o,u,s,c,v,h,p,d,f,b,y,g,m,x,w,C,S,_,k,T=this,A=a.showLatestNovels,N=a.filters;return t(this,(function(t){switch(t.label){case 0:if(r="".concat(this.site,"catalog/"),A)r+="?ordering=-time_updated&page=".concat(e);else if(N){for(o=new URLSearchParams,u=0,s=N.country.value;u<s.length;u++)c=s[u],o.append("country",c);for(v=0,h=N.genres.value;v<h.length;v++)p=h[v],o.append("genre",p);for(d=0,f=N.translation.value;d<f.length;d++)b=f[d],o.append("translation",b);for(y=0,g=N.status.value;y<g.length;y++)m=g[y],o.append("status",m);for(x=0,w=N.novel_type.value;x<w.length;x++)C=w[x],o.append("type",C);o.append("ordering",N.sort.value),o.append("page",e.toString()),r+="?".concat(o.toString())}else r+="?&ordering=popularity&page=".concat(e);return[4,(0,n.fetchApi)(r).then((function(e){return e.text()}))];case 1:return S=t.sent(),_=(0,l.load)(S),k=[],_("a.item").each((function(e,t){var a=_(t).find("div.title").text().trim(),l=t.attribs.href,n=_(t).find("img").attr("src"),r=n?T.site+n:i.defaultCover;if(l){var o={name:a,cover:null!=r?r:i.defaultCover,path:l.replace("/","")};k.push(o)}})),[2,k]}}))}))},a.prototype.parseNovel=function(a){return e(this,void 0,void 0,(function(){var e,o,i,u,s,c,v,h,p,d;return t(this,(function(t){switch(t.label){case 0:return[4,(0,n.fetchApi)(this.site+a).then((function(e){return e.text()}))];case 1:for(e=t.sent(),o=(0,l.load)(e),i={path:a,name:o("h1").text()||"Untitled",cover:this.site+o(".poster > img").attr("src"),summary:o("section.text-info.section > p").text(),totalPages:o("#select-pagination-chapter > option").length,chapters:[]},u=o("div.mini-info > .item").toArray(),s="",c="",v=0,h=u;v<h.length;v++)p=h[v],"Status"===(d=o(p).find(".sub-header").text().trim())&&(s=o(p).find("div.info").text().trim().toLowerCase()),"Translation"===d&&(c=o(p).find("div.info").text().trim().toLowerCase()),"Author"===d&&(i.author=o(p).find("div.info").text().trim()),"Genres"===d&&(i.genres=o(p).find("div.info > a").map((function(e,t){return o(t).text()})).toArray().join(", "));return"cancelled"===s?i.status=r.NovelStatus.Cancelled:"releasing"===s||"ongoing"===c?i.status=r.NovelStatus.Ongoing:"completed"===s&&"completed"===c&&(i.status=r.NovelStatus.Completed),[2,i]}}))}))},a.prototype.parsePage=function(a,r){return e(this,void 0,void 0,(function(){var e,o,i,s,c,v,h,p,d,f,b,y,g,m,x=this;return t(this,(function(t){switch(t.label){case 0:return[4,(0,n.fetchApi)(this.site+a).then((function(e){return e.text()}))];case 1:return e=t.sent(),o=null===(d=null==e?void 0:e.match(/window\.CSRF_TOKEN = "([^"]+)"/))||void 0===d?void 0:d[1],i=null===(f=null==e?void 0:e.match(/const OBJECT_BY_COMMENT = ([0-9]+)/))||void 0===f?void 0:f[1],s=parseInt(null!==(m=null===(g=null===(y=null===(b=null==e?void 0:e.match(/<option value="([0-9]+)"/g))||void 0===b?void 0:b.at(-1))||void 0===y?void 0:y.match(/([0-9]+)/))||void 0===g?void 0:g[1])&&void 0!==m?m:"1"),[4,(0,n.fetchApi)("".concat(this.site,"book/ajax/chapter-pagination?csrfmiddlewaretoken=").concat(o,"&book_id=").concat(i,"&page=").concat(s-parseInt(r)+1),{headers:{Host:this.site.replace("https://","").replace("/",""),Referer:this.site+a,"X-Requested-With":"XMLHttpRequest"}})];case 2:c=t.sent(),t.label=3;case 3:return t.trys.push([3,5,,6]),[4,c.json()];case 4:return v=(v=t.sent()).html,[3,6];case 5:throw h=t.sent(),console.error("Error Parsing Response"),console.error(h),new Error(h);case 6:return p=[],(0,l.load)("<html>"+v+"</html>")("a").each((function(e,t){var a=(0,l.load)(t)(".title").text().trim(),n=!!(0,l.load)(t)(".cost").text().trim();if(!x.hideLocked||!n){var o;try{o=(0,u.default)((0,l.load)(t)(".date").text().trim(),"DD.MM.YYYY").toISOString()}catch(e){}var i=n?"ðŸ”’ "+a:a,s=t.attribs.href;"/"==s.charAt(0)&&(s=s.substring(1)),p.push({name:i,path:s,page:r,releaseTime:o})}})),[2,{chapters:p.reverse()}]}}))}))},a.prototype.parseChapter=function(a){return e(this,void 0,void 0,(function(){var r,o,i,u,s,c,v,h,p=this;return t(this,(function(d){switch(d.label){case 0:return"/"==a.charAt(0)&&(a=a.substring(1)),[4,(0,n.fetchApi)(this.site+a).then((function(e){return e.text()}))];case 1:return r=d.sent(),o=null===(v=null==r?void 0:r.match(/window\.CSRF_TOKEN = "([^"]+)"/))||void 0===v?void 0:v[1],i=null===(h=null==r?void 0:r.match(/const CHAPTER_ID = "([0-9]+)/))||void 0===h?void 0:h[1],[4,(0,n.fetchApi)(this.site+"book/ajax/read-chapter/"+i,{method:"GET",headers:{Cookie:"csrftoken="+o,Referer:this.site+a,"X-Requested-With":"XMLHttpRequest"}}).then((function(a){return e(p,void 0,void 0,(function(){var e;return t(this,(function(t){switch(t.label){case 0:return[4,a.json()];case 1:return e=t.sent(),u=e.class,[2,e.content]}}))}))}))];case 2:return s=d.sent(),(c=(0,l.load)(s))("script").remove(),c(".".concat(u," > *:not(br)")).after("<br>"),[2,(c("."+u).html()||"").replace(/class="advertisment"/g,'style="display:none;"')]}}))}))},a.prototype.searchNovels=function(a){return e(this,void 0,void 0,(function(){var e,r,o,u,s=this;return t(this,(function(t){switch(t.label){case 0:return e="".concat(this.site,"catalog/?search=").concat(encodeURIComponent(a)),[4,(0,n.fetchApi)(e).then((function(e){return e.text()}))];case 1:return r=t.sent(),o=(0,l.load)(r),u=[],o("a.item").each((function(e,t){var a=o(t).find("div.title").text().trim(),l=t.attribs.href,n=o(t).find("img").attr("src"),r=n?s.site+n:i.defaultCover;if(l){var c={name:a,cover:null!=r?r:i.defaultCover,path:l.replace("/","")};u.push(c)}})),[2,u]}}))}))},a}();exports.default=new c;